# 3×3均值滤波模块 - 时序分析文档

## 📋 概述

本文档详细说明了在 `example_top.v` 中集成的3×3均值滤波模块的时序特征和帧同步机制。

---

## 🔧 模块配置

### 基本参数
- **输入分辨率**: 1280 × 720 @ CSI时钟频率
- **滤波算法**: 3×3均值滤波（9像素平均）
- **行缓存**: 9个SRAM IP核（3行 × RGB三通道）
- **SRAM容量**: 每个2KB (2048 × 8-bit)
- **工作时钟**: `w_csi_rx_clk` (与MIPI CSI接收器同步)

---

## ⏱️ 流水线延迟分析

### 总延迟：**4个时钟周期** + **2行图像延迟**

#### 详细流水线结构：

```
时钟周期:    T0      T1      T2      T3      T4
            ──────────────────────────────────────
输入数据:   Pixel(n,m)
            │
            ├─→ Stage 0: 输入寄存
            │   - 写入当前行SRAM
            │   - 发起读取前2行命令
            │
            └─→ Stage 1: SRAM读延迟 (1 cycle)
                │   - row0_data, row1_data 有效
                │   - row2_sr[0] = 当前像素
                │
                └─→ Stage 2: 构建3×3窗口
                    │   - 3个行的shift registers填充
                    │   - 3列数据准备就绪
                    │
                    └─→ Stage 3: 求和计算
                        │   - 9个像素累加
                        │   - sum_r/g/b 输出
                        │
                        └─→ Stage 4: 除法输出
                            - 乘以57，右移9位
                            - o_r/g/b 输出 (滤波后)
```

### 时序特征：

| 信号 | 输入 → 输出延迟 | 说明 |
|------|----------------|------|
| **vsync** | 3 cycles | 通过3级寄存器流水线 |
| **hsync** | 3 cycles | 同步对齐 |
| **de** | 3 cycles | 数据有效信号匹配 |
| **RGB数据** | 4 cycles | 包含计算延迟 |
| **首行输出** | 2行 + 4周期 | 需要缓存前2行数据 |

---

## 📊 边界处理

### 无效区域：
- **前2行**: 无输出（等待行缓存填充）
- **前2列**: 无输出（等待3×3窗口建立）

### 有效输出区域：
```
Frame: 1280 × 720
│
├─ Row 0-1: 丢弃（行缓存未满）
│
└─ Row 2-719: 有效输出
   │
   ├─ Col 0-1: 丢弃（窗口未建立）
   │
   └─ Col 2-1279: 滤波输出 (1278 有效像素)
```

### 实际输出分辨率：
- **有效像素**: 1278 × 718 像素
- **帧尺寸**: 保持1280 × 720（边缘填充0或保持原值）

---

## 🔄 帧同步机制

### 1. 帧起始检测
```verilog
wire frame_start = i_vsync & ~vsync_d;  // 上升沿检测
```
- **作用**: 在每帧开始时重置所有计数器
- **重置内容**:
  - 行/列计数器
  - SRAM写行选择器 (`wr_row_sel`)
  - 读写地址指针

### 2. 行循环缓存
```
帧内行序:  0   1   2   3   4   5   ...
           │   │   │   │   │   │
SRAM写入:  R0  R1  R2  R0  R1  R2  ...
           ↓   ↓   ↓   ↓   ↓   ↓
读取顺序: (R1,R2) (R2,R0) (R0,R1) (R1,R2) ...
```

### 3. 读写分离
- **写端口**: 总是写入当前行到选定的SRAM
- **读端口**: 同时读取前2行的数据
- **无冲突**: 简单双端口SRAM支持同时读写不同地址

---

## ⚠️ 关键时序要求

### 1. 输入时序
```verilog
输入要求:
- i_vsync: 帧同步信号，每帧上升沿触发
- i_hsync: 行同步信号（可选，本设计未使用）
- i_de: 数据有效信号，每行连续1280个周期
- i_r/g/b: 在 i_de=1 时提供有效数据
```

### 2. 输出时序保证
```verilog
输出特征:
- o_vsync: 延迟3周期后的 i_vsync
- o_de: 仅在有效窗口（row≥2, col≥2）时置1
- o_r/g/b: 在 o_de=1 时输出滤波结果
```

### 3. SRAM访问模式
```
每个像素周期:
1. 写操作: 当前像素 → 当前行SRAM
2. 读操作: 前2行SRAM → 读数据寄存器
3. 延迟: 1个周期后读数据有效
```

---

## 🔌 与DDR控制器的连接

### 数据路径：
```
MIPI CSI → Bayer2RGB → 白平衡 → [均值滤波] → DDR写入
                                      ↓
                        使用9个SRAM作为行缓存
```

### 连接信号：
```verilog
// 输入（来自白平衡模块）
.i_vsync    (rgb_vsync)      // 帧同步
.i_de       (rgb_valid)      // 数据有效
.i_r/g/b    (rgb_data[23:0]) // RGB数据

// 输出（送入DDR控制器）
.o_vsync    (w_filter_vsync)    // 同步到DDR
.o_de       (w_filter_valid)    // 写使能
.o_r/g/b    (w_filter_rgb[23:0]) // 滤波后数据
```

### 时钟域：
- **单一时钟域**: `w_csi_rx_clk`
- **无需CDC**: 滤波器与前后模块在同一时钟域
- **帧率保持**: 输入输出帧率一致（30 FPS）

---

## 📈 性能分析

### 资源占用：
| 资源类型 | 数量 | 说明 |
|---------|------|------|
| SRAM模块 | 9个 | 每个2KB，共18KB |
| 移位寄存器 | 27个字节 | 3行×3列×3通道 |
| 乘法器 | 3个 | RGB各1个（14-bit × 6-bit） |
| 加法器 | 多个 | 9像素求和树 |
| 计数器 | 2个12-bit | 行列计数 |

### 时序性能：
- **最大时钟频率**: 取决于乘法器和加法树延迟
- **预期Fmax**: > 100 MHz（CSI时钟通常 < 100 MHz）
- **流水线吞吐率**: 1像素/周期（稳态）

### 带宽需求：
```
输入带宽  = 1280 × 720 × 30 FPS × 3 Bytes = 82.944 MB/s
SRAM访问  = 每像素 2读 + 1写 = 3次访问 × 82.944 MB/s = 248.832 MB/s
输出带宽  = 82.944 MB/s
```

---

## 🐛 调试建议

### 1. 验证帧同步
```verilog
// 在仿真或ChipScope中监控：
- i_vsync, o_vsync  // 应相差3周期
- row_cnt, col_cnt  // 是否正确计数
- wr_row_sel        // 是否循环 0→1→2→0
```

### 2. 检查行缓存
```verilog
// 观察SRAM读写：
- sram_r0/1/2_r/g/b_we    // 写使能
- sram_r0/1/2_r/g/b_waddr // 写地址应0→1279循环
- sram_r0/1/2_r/g/b_rdata // 读数据是否为前几行
```

### 3. 验证滤波效果
```verilog
// 简单测试图案：
- 输入纯色块 → 输出应一致
- 输入棋盘格 → 输出应平滑
- 输入边缘 → 输出应模糊
```

---

## ⚙️ 配置选项

### 修改分辨率：
```verilog
// 在实例化时修改参数：
Mean_Filter_3x3 #(
    .IMG_WIDTH  (1920),  // 修改为新宽度
    .IMG_HEIGHT (1080)   // 修改为新高度
) u_mean_filter (...);
```

### 修改滤波算法：
如需更改滤波类型（如高斯滤波），修改以下部分：
```verilog
// 在 Mean_Filter_3x3.v 中修改权重：
sum_r <= (row0_r_sr[0] * W00) + (row0_r_sr[1] * W01) + ...
```

---

## ✅ 验证检查清单

- [x] SRAM IP核正确实例化（9个）
- [x] 滤波模块时钟连接到 `w_csi_rx_clk`
- [x] 复位信号正确（`rstn_sys`）
- [x] 输入连接到白平衡输出
- [x] 输出连接到DDR控制器输入
- [x] vsync/hsync/de信号对齐
- [x] 无组合环路
- [x] 所有信号位宽匹配

---

## 📞 技术支持

如遇问题，请检查：
1. SRAM IP核是否正确生成并添加到项目
2. 时钟约束是否正确设置
3. 是否满足SRAM的建立/保持时间
4. DDR控制器是否正确接收滤波数据

---

**文档版本**: 1.0  
**创建日期**: 2025-10-20  
**适用项目**: Ti60F225_HDMI_A2020_30FPS_Fixed

