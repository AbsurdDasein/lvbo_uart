# 3Ã—3å‡å€¼æ»¤æ³¢æ¨¡å— - æ—¶åºåˆ†æžæ–‡æ¡£

## ðŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜Žäº†åœ¨ `example_top.v` ä¸­é›†æˆçš„3Ã—3å‡å€¼æ»¤æ³¢æ¨¡å—çš„æ—¶åºç‰¹å¾å’Œå¸§åŒæ­¥æœºåˆ¶ã€‚

---

## ðŸ”§ æ¨¡å—é…ç½®

### åŸºæœ¬å‚æ•°
- **è¾“å…¥åˆ†è¾¨çŽ‡**: 1280 Ã— 720 @ CSIæ—¶é’Ÿé¢‘çŽ‡
- **æ»¤æ³¢ç®—æ³•**: 3Ã—3å‡å€¼æ»¤æ³¢ï¼ˆ9åƒç´ å¹³å‡ï¼‰
- **è¡Œç¼“å­˜**: 9ä¸ªSRAM IPæ ¸ï¼ˆ3è¡Œ Ã— RGBä¸‰é€šé“ï¼‰
- **SRAMå®¹é‡**: æ¯ä¸ª2KB (2048 Ã— 8-bit)
- **å·¥ä½œæ—¶é’Ÿ**: `w_csi_rx_clk` (ä¸ŽMIPI CSIæŽ¥æ”¶å™¨åŒæ­¥)

---

## â±ï¸ æµæ°´çº¿å»¶è¿Ÿåˆ†æž

### æ€»å»¶è¿Ÿï¼š**4ä¸ªæ—¶é’Ÿå‘¨æœŸ** + **2è¡Œå›¾åƒå»¶è¿Ÿ**

#### è¯¦ç»†æµæ°´çº¿ç»“æž„ï¼š

```
æ—¶é’Ÿå‘¨æœŸ:    T0      T1      T2      T3      T4
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
è¾“å…¥æ•°æ®:   Pixel(n,m)
            â”‚
            â”œâ”€â†’ Stage 0: è¾“å…¥å¯„å­˜
            â”‚   - å†™å…¥å½“å‰è¡ŒSRAM
            â”‚   - å‘èµ·è¯»å–å‰2è¡Œå‘½ä»¤
            â”‚
            â””â”€â†’ Stage 1: SRAMè¯»å»¶è¿Ÿ (1 cycle)
                â”‚   - row0_data, row1_data æœ‰æ•ˆ
                â”‚   - row2_sr[0] = å½“å‰åƒç´ 
                â”‚
                â””â”€â†’ Stage 2: æž„å»º3Ã—3çª—å£
                    â”‚   - 3ä¸ªè¡Œçš„shift registerså¡«å……
                    â”‚   - 3åˆ—æ•°æ®å‡†å¤‡å°±ç»ª
                    â”‚
                    â””â”€â†’ Stage 3: æ±‚å’Œè®¡ç®—
                        â”‚   - 9ä¸ªåƒç´ ç´¯åŠ 
                        â”‚   - sum_r/g/b è¾“å‡º
                        â”‚
                        â””â”€â†’ Stage 4: é™¤æ³•è¾“å‡º
                            - ä¹˜ä»¥57ï¼Œå³ç§»9ä½
                            - o_r/g/b è¾“å‡º (æ»¤æ³¢åŽ)
```

### æ—¶åºç‰¹å¾ï¼š

| ä¿¡å· | è¾“å…¥ â†’ è¾“å‡ºå»¶è¿Ÿ | è¯´æ˜Ž |
|------|----------------|------|
| **vsync** | 3 cycles | é€šè¿‡3çº§å¯„å­˜å™¨æµæ°´çº¿ |
| **hsync** | 3 cycles | åŒæ­¥å¯¹é½ |
| **de** | 3 cycles | æ•°æ®æœ‰æ•ˆä¿¡å·åŒ¹é… |
| **RGBæ•°æ®** | 4 cycles | åŒ…å«è®¡ç®—å»¶è¿Ÿ |
| **é¦–è¡Œè¾“å‡º** | 2è¡Œ + 4å‘¨æœŸ | éœ€è¦ç¼“å­˜å‰2è¡Œæ•°æ® |

---

## ðŸ“Š è¾¹ç•Œå¤„ç†

### æ— æ•ˆåŒºåŸŸï¼š
- **å‰2è¡Œ**: æ— è¾“å‡ºï¼ˆç­‰å¾…è¡Œç¼“å­˜å¡«å……ï¼‰
- **å‰2åˆ—**: æ— è¾“å‡ºï¼ˆç­‰å¾…3Ã—3çª—å£å»ºç«‹ï¼‰

### æœ‰æ•ˆè¾“å‡ºåŒºåŸŸï¼š
```
Frame: 1280 Ã— 720
â”‚
â”œâ”€ Row 0-1: ä¸¢å¼ƒï¼ˆè¡Œç¼“å­˜æœªæ»¡ï¼‰
â”‚
â””â”€ Row 2-719: æœ‰æ•ˆè¾“å‡º
   â”‚
   â”œâ”€ Col 0-1: ä¸¢å¼ƒï¼ˆçª—å£æœªå»ºç«‹ï¼‰
   â”‚
   â””â”€ Col 2-1279: æ»¤æ³¢è¾“å‡º (1278 æœ‰æ•ˆåƒç´ )
```

### å®žé™…è¾“å‡ºåˆ†è¾¨çŽ‡ï¼š
- **æœ‰æ•ˆåƒç´ **: 1278 Ã— 718 åƒç´ 
- **å¸§å°ºå¯¸**: ä¿æŒ1280 Ã— 720ï¼ˆè¾¹ç¼˜å¡«å……0æˆ–ä¿æŒåŽŸå€¼ï¼‰

---

## ðŸ”„ å¸§åŒæ­¥æœºåˆ¶

### 1. å¸§èµ·å§‹æ£€æµ‹
```verilog
wire frame_start = i_vsync & ~vsync_d;  // ä¸Šå‡æ²¿æ£€æµ‹
```
- **ä½œç”¨**: åœ¨æ¯å¸§å¼€å§‹æ—¶é‡ç½®æ‰€æœ‰è®¡æ•°å™¨
- **é‡ç½®å†…å®¹**:
  - è¡Œ/åˆ—è®¡æ•°å™¨
  - SRAMå†™è¡Œé€‰æ‹©å™¨ (`wr_row_sel`)
  - è¯»å†™åœ°å€æŒ‡é’ˆ

### 2. è¡Œå¾ªçŽ¯ç¼“å­˜
```
å¸§å†…è¡Œåº:  0   1   2   3   4   5   ...
           â”‚   â”‚   â”‚   â”‚   â”‚   â”‚
SRAMå†™å…¥:  R0  R1  R2  R0  R1  R2  ...
           â†“   â†“   â†“   â†“   â†“   â†“
è¯»å–é¡ºåº: (R1,R2) (R2,R0) (R0,R1) (R1,R2) ...
```

### 3. è¯»å†™åˆ†ç¦»
- **å†™ç«¯å£**: æ€»æ˜¯å†™å…¥å½“å‰è¡Œåˆ°é€‰å®šçš„SRAM
- **è¯»ç«¯å£**: åŒæ—¶è¯»å–å‰2è¡Œçš„æ•°æ®
- **æ— å†²çª**: ç®€å•åŒç«¯å£SRAMæ”¯æŒåŒæ—¶è¯»å†™ä¸åŒåœ°å€

---

## âš ï¸ å…³é”®æ—¶åºè¦æ±‚

### 1. è¾“å…¥æ—¶åº
```verilog
è¾“å…¥è¦æ±‚:
- i_vsync: å¸§åŒæ­¥ä¿¡å·ï¼Œæ¯å¸§ä¸Šå‡æ²¿è§¦å‘
- i_hsync: è¡ŒåŒæ­¥ä¿¡å·ï¼ˆå¯é€‰ï¼Œæœ¬è®¾è®¡æœªä½¿ç”¨ï¼‰
- i_de: æ•°æ®æœ‰æ•ˆä¿¡å·ï¼Œæ¯è¡Œè¿žç»­1280ä¸ªå‘¨æœŸ
- i_r/g/b: åœ¨ i_de=1 æ—¶æä¾›æœ‰æ•ˆæ•°æ®
```

### 2. è¾“å‡ºæ—¶åºä¿è¯
```verilog
è¾“å‡ºç‰¹å¾:
- o_vsync: å»¶è¿Ÿ3å‘¨æœŸåŽçš„ i_vsync
- o_de: ä»…åœ¨æœ‰æ•ˆçª—å£ï¼ˆrowâ‰¥2, colâ‰¥2ï¼‰æ—¶ç½®1
- o_r/g/b: åœ¨ o_de=1 æ—¶è¾“å‡ºæ»¤æ³¢ç»“æžœ
```

### 3. SRAMè®¿é—®æ¨¡å¼
```
æ¯ä¸ªåƒç´ å‘¨æœŸ:
1. å†™æ“ä½œ: å½“å‰åƒç´  â†’ å½“å‰è¡ŒSRAM
2. è¯»æ“ä½œ: å‰2è¡ŒSRAM â†’ è¯»æ•°æ®å¯„å­˜å™¨
3. å»¶è¿Ÿ: 1ä¸ªå‘¨æœŸåŽè¯»æ•°æ®æœ‰æ•ˆ
```

---

## ðŸ”Œ ä¸ŽDDRæŽ§åˆ¶å™¨çš„è¿žæŽ¥

### æ•°æ®è·¯å¾„ï¼š
```
MIPI CSI â†’ Bayer2RGB â†’ ç™½å¹³è¡¡ â†’ [å‡å€¼æ»¤æ³¢] â†’ DDRå†™å…¥
                                      â†“
                        ä½¿ç”¨9ä¸ªSRAMä½œä¸ºè¡Œç¼“å­˜
```

### è¿žæŽ¥ä¿¡å·ï¼š
```verilog
// è¾“å…¥ï¼ˆæ¥è‡ªç™½å¹³è¡¡æ¨¡å—ï¼‰
.i_vsync    (rgb_vsync)      // å¸§åŒæ­¥
.i_de       (rgb_valid)      // æ•°æ®æœ‰æ•ˆ
.i_r/g/b    (rgb_data[23:0]) // RGBæ•°æ®

// è¾“å‡ºï¼ˆé€å…¥DDRæŽ§åˆ¶å™¨ï¼‰
.o_vsync    (w_filter_vsync)    // åŒæ­¥åˆ°DDR
.o_de       (w_filter_valid)    // å†™ä½¿èƒ½
.o_r/g/b    (w_filter_rgb[23:0]) // æ»¤æ³¢åŽæ•°æ®
```

### æ—¶é’ŸåŸŸï¼š
- **å•ä¸€æ—¶é’ŸåŸŸ**: `w_csi_rx_clk`
- **æ— éœ€CDC**: æ»¤æ³¢å™¨ä¸Žå‰åŽæ¨¡å—åœ¨åŒä¸€æ—¶é’ŸåŸŸ
- **å¸§çŽ‡ä¿æŒ**: è¾“å…¥è¾“å‡ºå¸§çŽ‡ä¸€è‡´ï¼ˆ30 FPSï¼‰

---

## ðŸ“ˆ æ€§èƒ½åˆ†æž

### èµ„æºå ç”¨ï¼š
| èµ„æºç±»åž‹ | æ•°é‡ | è¯´æ˜Ž |
|---------|------|------|
| SRAMæ¨¡å— | 9ä¸ª | æ¯ä¸ª2KBï¼Œå…±18KB |
| ç§»ä½å¯„å­˜å™¨ | 27ä¸ªå­—èŠ‚ | 3è¡ŒÃ—3åˆ—Ã—3é€šé“ |
| ä¹˜æ³•å™¨ | 3ä¸ª | RGBå„1ä¸ªï¼ˆ14-bit Ã— 6-bitï¼‰ |
| åŠ æ³•å™¨ | å¤šä¸ª | 9åƒç´ æ±‚å’Œæ ‘ |
| è®¡æ•°å™¨ | 2ä¸ª12-bit | è¡Œåˆ—è®¡æ•° |

### æ—¶åºæ€§èƒ½ï¼š
- **æœ€å¤§æ—¶é’Ÿé¢‘çŽ‡**: å–å†³äºŽä¹˜æ³•å™¨å’ŒåŠ æ³•æ ‘å»¶è¿Ÿ
- **é¢„æœŸFmax**: > 100 MHzï¼ˆCSIæ—¶é’Ÿé€šå¸¸ < 100 MHzï¼‰
- **æµæ°´çº¿åžåçŽ‡**: 1åƒç´ /å‘¨æœŸï¼ˆç¨³æ€ï¼‰

### å¸¦å®½éœ€æ±‚ï¼š
```
è¾“å…¥å¸¦å®½  = 1280 Ã— 720 Ã— 30 FPS Ã— 3 Bytes = 82.944 MB/s
SRAMè®¿é—®  = æ¯åƒç´  2è¯» + 1å†™ = 3æ¬¡è®¿é—® Ã— 82.944 MB/s = 248.832 MB/s
è¾“å‡ºå¸¦å®½  = 82.944 MB/s
```

---

## ðŸ› è°ƒè¯•å»ºè®®

### 1. éªŒè¯å¸§åŒæ­¥
```verilog
// åœ¨ä»¿çœŸæˆ–ChipScopeä¸­ç›‘æŽ§ï¼š
- i_vsync, o_vsync  // åº”ç›¸å·®3å‘¨æœŸ
- row_cnt, col_cnt  // æ˜¯å¦æ­£ç¡®è®¡æ•°
- wr_row_sel        // æ˜¯å¦å¾ªçŽ¯ 0â†’1â†’2â†’0
```

### 2. æ£€æŸ¥è¡Œç¼“å­˜
```verilog
// è§‚å¯ŸSRAMè¯»å†™ï¼š
- sram_r0/1/2_r/g/b_we    // å†™ä½¿èƒ½
- sram_r0/1/2_r/g/b_waddr // å†™åœ°å€åº”0â†’1279å¾ªçŽ¯
- sram_r0/1/2_r/g/b_rdata // è¯»æ•°æ®æ˜¯å¦ä¸ºå‰å‡ è¡Œ
```

### 3. éªŒè¯æ»¤æ³¢æ•ˆæžœ
```verilog
// ç®€å•æµ‹è¯•å›¾æ¡ˆï¼š
- è¾“å…¥çº¯è‰²å— â†’ è¾“å‡ºåº”ä¸€è‡´
- è¾“å…¥æ£‹ç›˜æ ¼ â†’ è¾“å‡ºåº”å¹³æ»‘
- è¾“å…¥è¾¹ç¼˜ â†’ è¾“å‡ºåº”æ¨¡ç³Š
```

---

## âš™ï¸ é…ç½®é€‰é¡¹

### ä¿®æ”¹åˆ†è¾¨çŽ‡ï¼š
```verilog
// åœ¨å®žä¾‹åŒ–æ—¶ä¿®æ”¹å‚æ•°ï¼š
Mean_Filter_3x3 #(
    .IMG_WIDTH  (1920),  // ä¿®æ”¹ä¸ºæ–°å®½åº¦
    .IMG_HEIGHT (1080)   // ä¿®æ”¹ä¸ºæ–°é«˜åº¦
) u_mean_filter (...);
```

### ä¿®æ”¹æ»¤æ³¢ç®—æ³•ï¼š
å¦‚éœ€æ›´æ”¹æ»¤æ³¢ç±»åž‹ï¼ˆå¦‚é«˜æ–¯æ»¤æ³¢ï¼‰ï¼Œä¿®æ”¹ä»¥ä¸‹éƒ¨åˆ†ï¼š
```verilog
// åœ¨ Mean_Filter_3x3.v ä¸­ä¿®æ”¹æƒé‡ï¼š
sum_r <= (row0_r_sr[0] * W00) + (row0_r_sr[1] * W01) + ...
```

---

## âœ… éªŒè¯æ£€æŸ¥æ¸…å•

- [x] SRAM IPæ ¸æ­£ç¡®å®žä¾‹åŒ–ï¼ˆ9ä¸ªï¼‰
- [x] æ»¤æ³¢æ¨¡å—æ—¶é’Ÿè¿žæŽ¥åˆ° `w_csi_rx_clk`
- [x] å¤ä½ä¿¡å·æ­£ç¡®ï¼ˆ`rstn_sys`ï¼‰
- [x] è¾“å…¥è¿žæŽ¥åˆ°ç™½å¹³è¡¡è¾“å‡º
- [x] è¾“å‡ºè¿žæŽ¥åˆ°DDRæŽ§åˆ¶å™¨è¾“å…¥
- [x] vsync/hsync/deä¿¡å·å¯¹é½
- [x] æ— ç»„åˆçŽ¯è·¯
- [x] æ‰€æœ‰ä¿¡å·ä½å®½åŒ¹é…

---

## ðŸ“ž æŠ€æœ¯æ”¯æŒ

å¦‚é‡é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. SRAM IPæ ¸æ˜¯å¦æ­£ç¡®ç”Ÿæˆå¹¶æ·»åŠ åˆ°é¡¹ç›®
2. æ—¶é’Ÿçº¦æŸæ˜¯å¦æ­£ç¡®è®¾ç½®
3. æ˜¯å¦æ»¡è¶³SRAMçš„å»ºç«‹/ä¿æŒæ—¶é—´
4. DDRæŽ§åˆ¶å™¨æ˜¯å¦æ­£ç¡®æŽ¥æ”¶æ»¤æ³¢æ•°æ®

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-20  
**é€‚ç”¨é¡¹ç›®**: Ti60F225_HDMI_A2020_30FPS_Fixed

