# 3×3均值滤波模块 - 快速使用指南

## 🎯 功能说明

本项目在原有的MIPI CSI图像采集系统中集成了一个**3×3均值滤波器**，用于实时图像降噪处理。

### 主要特点：
- ✅ 实时处理：1280×720 @ 30FPS
- ✅ 使用9个片上SRAM作为行缓存（18KB总容量）
- ✅ 流水线架构，1像素/周期吞吐率
- ✅ 自动帧同步，无需手动控制
- ✅ 无损集成到现有视频流水线

---

## 📂 文件清单

### 新增文件：
| 文件名 | 说明 |
|--------|------|
| `Mean_Filter_3x3.v` | 3×3均值滤波核心模块 |
| `Mean_Filter_Timing_Analysis.md` | 详细时序分析文档 |
| `README_Mean_Filter.md` | 本文件（快速使用指南） |

### 修改文件：
| 文件名 | 修改内容 |
|--------|----------|
| `example_top.v` | 添加9个SRAM实例 + 滤波模块实例 + 数据流连接 |

### SRAM IP核：
需要确保以下SRAM IP核已正确生成并添加到项目：
```
ip/sram_r0_r/
ip/sram_r0_g/
ip/sram_r0_b/
ip/sram_r1_r/
ip/sram_r1_g/
ip/sram_r1_b/
ip/sram_r2_r/
ip/sram_r2_g/
ip/sram_r2_b/
```

---

## 🔌 数据流路径

```
┌─────────────┐
│  MIPI CSI   │  RAW8 Bayer
│   Camera    │  1280×960
└──────┬──────┘
       │
       ↓
┌─────────────┐
│  Bayer2RGB  │  RAW8 → RGB888
└──────┬──────┘
       │
       ↓
┌─────────────┐
│ 白平衡(MWB) │  颜色校正
└──────┬──────┘
       │
       ↓
┌─────────────────────┐
│  3×3均值滤波         │  ← 新增模块
│  (Mean_Filter_3x3)  │
│  使用9个SRAM行缓存   │
└──────┬──────────────┘
       │ 滤波后 RGB888
       ↓
┌─────────────┐
│  DDR3缓存   │  跨时钟域
└──────┬──────┘
       │
       ↓
┌─────────────┐
│ HDMI输出    │  1280×720 @ 60Hz
└─────────────┘
```

---

## ⚡ 快速集成步骤

### 1. 复制文件
```bash
# 将 Mean_Filter_3x3.v 放到项目根目录或源文件目录
cp Mean_Filter_3x3.v <项目源文件目录>
```

### 2. 确认SRAM IP核
确保9个SRAM IP核已生成并可用。每个SRAM配置：
- 类型：SDP_RAM（简单双端口）
- 地址宽度：11位（2048地址）
- 数据宽度：8位
- 模式：SPEED（速度优化）

### 3. 添加到项目
在Efinity IDE中：
1. 添加 `Mean_Filter_3x3.v` 到源文件列表
2. 确认所有SRAM IP核已正确链接
3. 重新编译项目

### 4. 时序约束
确保CSI时钟约束正确设置：
```tcl
create_clock -period 10.000 [get_ports csi_rxc_i]  # 根据实际频率调整
```

---

## 🔧 模块接口

### 输入：
```verilog
.clk        (w_csi_rx_clk)     // CSI接收时钟
.rst_n      (rstn_sys)         // 系统复位（低有效）
.i_vsync    (rgb_vsync)        // 帧同步
.i_hsync    (rgb_valid)        // 行同步/数据有效
.i_de       (rgb_valid)        // 数据使能
.i_r[7:0]   (rgb_data[23:16])  // 红色通道
.i_g[7:0]   (rgb_data[15:8])   // 绿色通道
.i_b[7:0]   (rgb_data[7:0])    // 蓝色通道
```

### 输出：
```verilog
.o_vsync    (w_filter_vsync)   // 帧同步（延迟3周期）
.o_hsync    (w_filter_valid)   // 数据有效
.o_de       (w_filter_valid)   // 数据使能
.o_r[7:0]   (w_filter_rgb[23:16])  // 滤波后红色
.o_g[7:0]   (w_filter_rgb[15:8])   // 滤波后绿色
.o_b[7:0]   (w_filter_rgb[7:0])    // 滤波后蓝色
```

---

## ⏱️ 延迟特性

### 流水线延迟：
- **数据延迟**: 4个时钟周期
- **首帧延迟**: 2行 + 4周期
- **同步延迟**: 3个时钟周期

### 有效输出区域：
- **跳过前2行**：等待行缓存填充
- **跳过前2列**：等待3×3窗口建立
- **实际有效输出**: 从第3行第3列开始

---

## 🎨 滤波效果

### 3×3均值滤波算法：
```
输出像素 = (周围9个像素之和) / 9
```

### 视觉效果：
- ✅ 降低高频噪声
- ✅ 平滑图像细节
- ⚠️ 可能导致轻微模糊
- ✅ 适合降噪预处理

### 适用场景：
- 低光照环境下的噪声抑制
- 传感器固定模式噪声消除
- 作为更复杂算法的预处理步骤

---

## 🔍 调试指南

### 1. 检查模块是否工作
观察LED输出：
```verilog
assign led_o[3:0] = w_axi_tp;  // DDR传输状态
assign led_o[4] = r_csi_fv_o[5];  // CSI帧计数器
```

### 2. 使用ChipScope观察信号
关键信号：
```
- rgb_vsync / w_filter_vsync  // 帧同步对比
- rgb_valid / w_filter_valid  // 数据有效信号
- rgb_data / w_filter_rgb     // 滤波前后数据对比
```

### 3. 验证SRAM访问
```
- w_sram_r0_r_we / _re        // 写/读使能
- w_sram_r0_r_waddr / _raddr  // 地址是否循环 0-1279
```

### 4. 检查输出图像
- 如果图像变模糊：滤波器正常工作
- 如果无变化：检查数据流连接
- 如果全黑/全白：检查SRAM初始化

---

## 📊 性能指标

| 指标 | 数值 |
|------|------|
| 输入分辨率 | 1280 × 720 |
| 帧率 | 30 FPS |
| 处理延迟 | 4 时钟周期 |
| 行缓存大小 | 18 KB (9×2KB) |
| 吞吐率 | 1 像素/周期 |
| 时钟频率 | CSI时钟（通常 < 100MHz） |

---

## 🛠️ 自定义修改

### 更改图像分辨率
修改 `example_top.v` 中的实例化参数：
```verilog
Mean_Filter_3x3 #(
    .IMG_WIDTH  (1920),  // 改为所需宽度
    .IMG_HEIGHT (1080)   // 改为所需高度
) u_mean_filter (...);
```

### 更改滤波算法
修改 `Mean_Filter_3x3.v` 中的计算逻辑：
```verilog
// 原始：3×3均值滤波（所有权重 = 1/9）
sum_r <= row0_r_sr[0] + row0_r_sr[1] + ... (9个像素)

// 改为高斯滤波（中心权重更大）：
sum_r <= (row1_r_sr[1] * 4) +           // 中心像素
         (row0_r_sr[1] * 2) + ... ;     // 边缘像素
```

### 添加滤波使能控制
在顶层模块添加控制信号：
```verilog
wire filter_enable = 1'b1;  // 或连接到寄存器

// 修改DDR输入：
.wframe_data    (filter_enable ? w_filter_rgb : rgb_data)
```

---

## ❗ 注意事项

### 1. 时钟域
- ⚠️ 所有信号必须在 `w_csi_rx_clk` 域内
- ⚠️ 不要将滤波器输出直接连接到其他时钟域

### 2. 复位
- ⚠️ 确保 `rstn_sys` 在所有PLL锁定后释放
- ⚠️ 复位期间SRAM内容不确定

### 3. 资源使用
- ℹ️ 本设计使用9个BRAM，确保FPGA有足够资源
- ℹ️ Ti60F225有足够的BRAM支持本设计

### 4. 边界像素
- ℹ️ 前2行2列无输出，DDR中对应位置可能为0或旧数据
- ℹ️ 如需完整帧，可在后续模块中补充边界

---

## 📈 预期改善

### 图像质量提升：
- SNR提升：约 3-5 dB（取决于原始噪声水平）
- 噪声降低：高频噪声明显减少
- 细节保留：中低频信息基本保留

### 适用环境：
- ✅ 静态场景：效果最佳
- ⚠️ 运动场景：可能产生轻微拖影
- ✅ 低光照：显著改善噪点

---

## 🆘 常见问题

### Q1: 输出图像全黑？
**A**: 检查以下项：
1. `w_filter_valid` 信号是否正确
2. SRAM是否正确初始化
3. 滤波器复位是否正常释放

### Q2: 图像有横条纹？
**A**: 可能原因：
1. 行缓存地址计数错误
2. `wr_row_sel` 循环异常
3. SRAM读写冲突（不太可能，SDP模式）

### Q3: 第一帧有异常？
**A**: 正常现象，原因：
1. SRAM初始值不确定
2. 前2行数据无效
3. 等待第二帧后稳定

### Q4: 滤波效果不明显？
**A**: 可能原因：
1. 原始图像噪声本身很低
2. 检查滤波器是否被bypass
3. 验证数据流是否经过滤波器

---

## 📚 参考文档

- **详细时序分析**: 见 `Mean_Filter_Timing_Analysis.md`
- **SRAM IP手册**: 见 `ip/sram_r0_r/` 目录下文档
- **原始项目文档**: 见项目README

---

## ✅ 验收测试

完成集成后，请验证：
- [ ] 项目编译无错误
- [ ] 时序约束满足
- [ ] HDMI输出正常显示
- [ ] 图像有轻微模糊（滤波效果）
- [ ] 帧率保持30FPS
- [ ] 无画面撕裂或花屏

---

**版本**: v1.0  
**日期**: 2025-10-20  
**作者**: Claude AI Assistant  
**项目**: Ti60F225 HDMI A2020 30FPS Fixed

如有任何问题，请检查 `Mean_Filter_Timing_Analysis.md` 获取详细技术信息。

